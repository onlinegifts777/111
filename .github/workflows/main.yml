# .github/workflows/main.yml
name: Ghost Intelligence Swarm Email Sender

on:
  workflow_dispatch:
    inputs:
      total_target_emails:
        description: 'Общее количество писем для отправки (целей из base.txt). Введите 0 для отправки всей базы.'
        required: true
        default: '0'
      test_mode_enabled:
        description: 'Включить тестовый режим (отправка только на TEST_EMAILS из config.py)'
        type: boolean
        required: true
        default: true
      max_parallel_runners:
        description: 'Максимальное количество параллельных GHA-ранеров (чем больше, тем быстрее, но дороже)'
        required: true
        default: '5'
      
jobs:
  prepare_dispatch:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
      all_accounts_content: ${{ steps.load_accounts.outputs.content }}
      is_test_mode: ${{ github.event.inputs.test_mode_enabled }}
    steps:
      - uses: actions/checkout@v3

      - name: Загрузка всех аккаунтов
        id: load_accounts
        run: |
          ACCOUNTS_CONTENT=$(cat resources/accounts.txt)
          echo "content=$ACCOUNTS_CONTENT" >> $GITHUB_OUTPUT 
          echo "Аккаунты загружены. Количество строк: $(echo "$ACCOUNTS_CONTENT" | wc -l)"

      - name: Загрузка config.py для доступа к BATCH_SIZE_PER_RUNNER
        run: |
          cp config.py .
          BATCH_SIZE=$(grep -oP 'BATCH_SIZE_PER_RUNNER = \K\d+' config.py || echo "100") 
          echo "BATCH_SIZE_PER_RUNNER=$BATCH_SIZE" >> $GITHUB_ENV
          echo "BATCH_SIZE_PER_RUNNER: $BATCH_SIZE"

      - name: Подготовка целей для рассылки и сохранение в артефакт
        id: prepare_targets
        run: |
          TARGETS_FILE="resources/base.txt"
          PROCESSED_TARGETS_FILE="processed_targets_for_dispatch.txt" # Имя файла, который будет артефактом

          if [ "${{ github.event.inputs.test_mode_enabled }}" == "true" ]; then
            echo "Работаем в тестовом режиме. Получатели будут взяты из config.py -> TEST_EMAILS."
            # Создаем пустой файл-заглушку, чтобы артефакт не был пустым, но mailer_worker.py его проигнорирует в TEST_MODE
            touch "$PROCESSED_TARGETS_FILE"
          else
            if [ ! -f "$TARGETS_FILE" ]; then
              echo "Ошибка: Файл базы получателей $TARGETS_FILE не найден. Убедитесь, что resources/base.txt существует и заполнен."
              exit 1 
            fi
            
            TOTAL_TARGETS=$(wc -l < "$TARGETS_FILE")
            echo "Всего получателей в base.txt: $TOTAL_TARGETS"

            REQUESTED_TARGETS=${{ github.event.inputs.total_target_emails }}
            if [ "$REQUESTED_TARGETS" -eq 0 ] || [ "$REQUESTED_TARGETS" -gt "$TOTAL_TARGETS" ]; then
                echo "Отправка всей базы получателей."
                cat "$TARGETS_FILE" > "$PROCESSED_TARGETS_FILE"
            else
                echo "Отправка $REQUESTED_TARGETS получателей."
                head -n "$REQUESTED_TARGETS" "$TARGETS_FILE" > "$PROCESSED_TARGETS_FILE"
            fi
          fi
          
          PROCESSED_TARGETS_COUNT=$(wc -l < "$PROCESSED_TARGETS_FILE")
          echo "Подготовлено получателей: $PROCESSED_TARGETS_COUNT"
          # Имя файла передаем как output
          echo "processed_targets_filename=$PROCESSED_TARGETS_FILE" >> $GITHUB_OUTPUT

      - name: Загрузка файла с целями как артефакта
        uses: actions/upload-artifact@v3
        with:
          name: targets-for-dispatch
          path: ${{ steps.prepare_targets.outputs.processed_targets_filename }}

      - name: Создание матрицы для GHA ранеров
        id: set_matrix
        run: |
          BATCH_SIZE=${{ env.BATCH_SIZE_PER_RUNNER }}
          IS_TEST_MODE="${{ github.event.inputs.test_mode_enabled }}"
          TARGETS_FILENAME="${{ steps.prepare_targets.outputs.processed_targets_filename }}"
          
          MATRIX_CONFIG_ITEMS=""
          RUNNER_ID=1

          if [ "$IS_TEST_MODE" == "true" ]; then
            MATRIX_CONFIG_ITEMS="{\"runner_id\": 1, \"targets_offset\": 0, \"targets_limit\": ${BATCH_SIZE}}"
          elif [ -s "$TARGETS_FILENAME" ]; then # Проверяем, что файл не пустой
            # Чтобы подсчитать строки, нужно прочитать файл. Здесь файл ещё не скачан,
            # но мы знаем его имя и ожидаем, что он будет загружен как артефакт.
            # Для надежности, можно было бы передать total_targets как output, но пока так.
            # В данном случае, так как файл только что создан, он еще доступен на этом же ранере.
            TOTAL_TARGETS=$(wc -l < "$TARGETS_FILENAME")
            echo "Всего целей для разбивки на пачки: $TOTAL_TARGETS"
            
            OFFSET=0
            while [ "$OFFSET" -lt "$TOTAL_TARGETS" ]; do
                MATRIX_CONFIG_ITEMS+="{\"runner_id\": ${RUNNER_ID}, \"targets_offset\": ${OFFSET}, \"targets_limit\": ${BATCH_SIZE}},"
                OFFSET=$((OFFSET + BATCH_SIZE))
                ((RUNNER_ID++))
            done
            MATRIX_CONFIG_ITEMS="${MATRIX_CONFIG_ITEMS%,}"
          else
            echo "Нет целей для рассылки в боевом режиме. Матрица пуста."
            MATRIX_CONFIG_ITEMS=""
          fi
          
          MATRIX_CONFIG="{\"include\": [${MATRIX_CONFIG_ITEMS}]}"
          echo "matrix=$MATRIX_CONFIG" >> $GITHUB_OUTPUT

  send_emails_swarm:
    needs: prepare_dispatch
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare_dispatch.outputs.matrix) }}
      max-parallel: ${{ github.event.inputs.max_parallel_runners }}
    
    steps:
      - uses: actions/checkout@v3

      - name: Загрузка Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Установка зависимостей
        run: pip install aiosmtplib

      - name: Создание папки ресурсов
        run: mkdir -p resources

      # Добавляем шаг для скачивания артефакта с целями
      - name: Скачивание файла с целями
        uses: actions/download-artifact@v3
        with:
          name: targets-for-dispatch
          path: . # Скачиваем в текущий рабочий каталог

      - name: Загрузка файлов ресурсов
        run: |
          cp config.py .
          cp -r resources/* resources/

          echo "${{ needs.prepare_dispatch.outputs.all_accounts_content }}" > resources/accounts.txt
          
          # Извлекаем свою пачку получателей для текущего ранера из скачанного файла
          if [ "${{ needs.prepare_dispatch.outputs.is_test_mode }}" == "true" ]; then
            echo "# Test mode active, mailer_worker will use TEST_EMAILS from config.py" > resources/base.txt
          else
            TARGETS_FILENAME="processed_targets_for_dispatch.txt" # Имя файла, который мы скачали
            OFFSET=${{ matrix.targets_offset }}
            LIMIT=${{ matrix.targets_limit }}
            
            tail -n +$((OFFSET + 1)) "$TARGETS_FILENAME" | head -n "$LIMIT" > resources/base.txt
          fi
          
          echo "--- Содержимое файлов ресурсов после загрузки ---"
          ls -l resources/
          echo "resources/accounts.txt (первые 3 строки):"
          head -n 3 resources/accounts.txt || true
          echo "resources/base.txt (содержимое):"
          cat resources/base.txt || true

      - name: Запуск Swarm Email Sender
        env:
          GHA_ACCOUNTS: "${{ needs.prepare_dispatch.outputs.all_accounts_content }}"
          GHA_TARGETS: "$(cat resources/base.txt)"
          GHA_RUNNER_ID: ${{ matrix.runner_id }}
        run: python mailer_worker.py

      - name: Сохранение логов рассылки
        uses: actions/upload-artifact@v3
        with:
          name: logs-${{ github.run_id }}-${{ matrix.runner_id }}
          path: |
            sent_log.csv
            error_log.csv
          if-no-files-found: ignore
